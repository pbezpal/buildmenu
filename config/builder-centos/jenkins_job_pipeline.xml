<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.39">
  <actions>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobAction plugin="pipeline-model-definition@1.7.0"/>
    <org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction plugin="pipeline-model-definition@1.7.0">
      <jobProperties/>
      <triggers/>
      <parameters/>
      <options/>
    </org.jenkinsci.plugins.pipeline.modeldefinition.actions.DeclarativeJobPropertyTrackerAction>
  </actions>
  <description></description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>BRANCH</name>
          <description></description>
          <defaultValue>master</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>VERSION</name>
          <description></description>
          <defaultValue>0.0.0</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>GIT_URL</name>
          <description></description>
          <defaultValue>ssh://shavlovskiy_sn@10.10.199.35/opt/git/firelink/web_server</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>BUILD_CMD</name>
          <description></description>
          <defaultValue>make</defaultValue>
          <trim>true</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>TYPE</name>
          <description></description>
          <defaultValue>server</defaultValue>
          <trim>true</trim>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>BUILD_TYPE</name>
          <description></description>
          <defaultValue>pre-relsease</defaultValue>
          <trim>false</trim>
        </hudson.model.StringParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.81">
    <script>#!groovy

String BRANCH = &quot;${params.BRANCH}&quot;
String VERSION = &quot;${params.VERSION}&quot;
String BUILD_CMD = &quot;${params.BUILD_CMD}&quot;
String TYPE = &quot;${params.TYPE}&quot;
String GIT_URL = &quot;${params.GIT_URL}&quot;
String BUILD_TYPE = &quot;${params.BUILD_TYPE}&quot;
String CURRENT_DATE = new Date().format(&apos;dd.MM.yyyy_HH:mm&apos;, TimeZone.getTimeZone(&quot;Europe/Moscow&quot;))
String FOLDER = &quot;${CURRENT_DATE}_${params.VERSION}-${BUILD_NUMBER}&quot;

def is_result_shell_build(command,text){
    if(currentBuild.result == &apos;SUCCESS&apos;){
        try{
            sh command    
        }catch(err){
            currentBuild.result = &apos;FAILURE&apos;
            error(text)
        }
    }
}

pipeline{
    agent {
        label &apos;centos&apos;
    }
    options { timestamps () }
    stages{
      
      stage(&quot;Cleaning the build directory&quot;){
        steps{
          deleteDir();
        }
      }
      stage(&quot;Cloning from a git repository&quot;){
        steps{
          echo &quot;========== Cloning GIT ==========&quot;
          script{
            try{
              checkout([$class: &apos;GitSCM&apos;, branches: [[name: &apos;${BRANCH}&apos;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: &apos;${GIT_URL}&apos;]]])
            }catch(err){
              currentBuild.result = &quot;FAILURE&quot;
              error(&quot;Error copying from git repository&quot;)
	          return;
            }
            if(BUILD_TYPE.equals(&apos;pre-release&apos;) || BUILD_TYPE.equals(&apos;release&apos;)){
                try{
                    sh &quot;sshpass -p \&quot;34appterr21\&quot; rsync -r -e ssh ${WORKSPACE}/* jenkins@10.10.199.31:/ftp/releases/RosChat/${TYPE}/${JOB_NAME}/${FOLDER}/&quot;
                }catch(err){
                    currentBuild.result = &quot;FAILURE&quot;
                    error(&quot;Error copying source code to ftp&quot;)
	                return;
                }
            }
		    currentBuild.result = &quot;SUCCESS&quot;
          }
        }
      }
      stage(&quot;Build rpm&quot;){
        steps{
          echo &quot;========== Build ${JOB_NAME}_${VERSION}-${BUILD_NUMBER} ==========&quot;
          is_result_shell_build(&quot;$BUILD_CMD&quot;,&quot;The result of the assembly - failed&quot;)
        }
      }
      stage(&quot;Push rpm to repo&quot;){
        steps{
          echo &quot;========== Push ${JOB_NAME}_${VERSION}-${BUILD_NUMBER} to repo ==========&quot;
          script{
            if(currentBuild.result == &apos;SUCCESS&apos;){
                if(BUILD_TYPE.equals(&apos;develop&apos;)){
                    is_result_shell_build(&quot;/opt/push_rpm_repo.sh ${WORKSPACE} ${JOB_NAME}.develop ${FOLDER}&quot;,&quot;Can&apos;t push rpm to ${JOB_NAME}.develop&quot;)
                }else if(BUILD_TYPE.equals(&apos;pre-release&apos;)){
                    is_result_shell_build(&quot;/opt/push_rpm_repo.sh ${WORKSPACE} ${JOB_NAME}.pre-release ${FOLDER}&quot;,&quot;Can&apos;t push rpm to ${JOB_NAME}.pre-release&quot;)
                }else if(BUILD_TYPE.equals(&apos;release&apos;)){
                    is_result_shell_build(&quot;/opt/push_rpm_repo.sh ${WORKSPACE} ${JOB_NAME}.release ${FOLDER}&quot;,&quot;Can&apos;t push rpm to ${JOB_NAME}.release&quot;)
                }
            }  
          }
        }
      }
      stage(&quot;Rsync rpm for build and testing server&quot;){
        steps{
            echo &quot;========== Rsync ${JOB_NAME}_${VERSION}-${BUILD_NUMBER} on server ==========&quot;
            is_result_shell_build(&quot;ssh root@10.10.199.47 rm -f /tmp/rpms/${JOB_NAME}-*&quot;,&quot;Can&apos;t remove old version rpm&quot;)
            is_result_shell_build(&quot;rsync ${WORKSPACE}/result/* root@10.10.199.47:/tmp/rpms&quot;,&quot;Can&apos;t push rpm&quot;)
            is_result_shell_build(&quot;echo ${JOB_NAME}_${VERSION}-${BUILD_NUMBER} &gt; /tmp/build&quot;,&quot;Can&apos;t write mark&quot;)
            is_result_shell_build(&quot;rsync /tmp/build root@10.10.199.47:/tmp&quot;,&quot;Can&apos;t push mark&quot;)
            is_result_shell_build(&quot;rm -f /tmp/build&quot;,&quot;Can&apos;t delete tmp mark&quot;)
        }
      }
      stage(&quot;Run job build server&quot;){
        steps{
          script{
            if(currentBuild.result == &apos;SUCCESS&apos;){
                build job: &apos;roschat-server_docker&apos;, wait: false   
            }
          }
        }
      }
    }
}</script>
    <sandbox>true</sandbox>
  </definition>
  <triggers/>
  <authToken>110afafd6a5bbe698b1e69a37390daaafd</authToken>
  <disabled>false</disabled>
</flow-definition>